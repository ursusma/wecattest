from django.shortcuts import render,render_to_response
from django.http import HttpResponse
from django.views.decorators.csrf import csrf_exempt

from django.utils.encoding import smart_str
from .models import *

import urllib.request
import re
import os
import hashlib
import json
import xml.etree.ElementTree as ET
import time
import requests
import tracback

# Create your views here.

wxtoken='yourtoken'
key = 'your tuling key'
autotexturl = 'http://www.tuling123.com/openapi/api'
appid = 'yourappid'
appsecret = 'yourappsecret'

@csrf_exempt
def lnr(request):

    def get(request):
        signature = request.GET.get("signature","")
        timestamp = request.GET.get("timestamp","")
        nonce = request.GET.get("nonce","")
        echostr = request.GET.get("echostr","")
        token = wxtoken

        tmp_list = [token,timestamp,nonce]
        tmp_list.sort()
        tmp_str = tmp_list[0] + tmp_list[1] + tmp_list[2]
        tmpstr = hashlib.sha1(tmp_str.encode('utf-8')).hexdigest()

        if tmpstr == signature:
            return echostr
        else:
            return 'error'

#    def accesstoken(request):
#        gettoken = 'https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=' + appid + '&secret=' + appsecret
#        getvalue = urllib.request.urlopen(gettoken).read()
#        value = json.loads(getvalue)
#        result = json['access_token']
#        buttonsetting(result)
#
#    def buttonsetting(result):
#        url = 'https://api.weixin.qq.com/cgi-bin/menu/create?access_token=' + result
#        data = {
#            "button":[
#            {
#                "type":"view",
#                "name":"test",
#                "url":"http://www.51huiu.cn/lnr"
#            },
#
#            {
#                "name":"tool set",
#                "sub_button":[
#                {
#                    "type":"click",
#                    "name":"joke",
#                    "key":"v1001_joke"
#                },
#                {
#                    "type":"click",
#                    "name":"translate",
#                    "key":"v1001_translate"
#                },
#                {
#                    "type":"click",
#                    "name":"weather",
#                    "key":"v1001_weather"
#                }
#                ]
#            },
#
#            {
#                "type":"view",
#                "name":"about me",
#                "url":"http://www.51huiu.cn/lnr"
#            }
#            ]
#        }
#        f = requests.post(url,data)

    def post(request):

        def getjson(xmldata):
            text = xmldata.find('Content').text.encode('utf-8')
            f = {"key":key,"info":text}
            r = requests.post(url,data=f)
            resp = r.text
            js = json.loads(resp)
            if js['code'] == 100000:
                return js['text'].replace('<br>','\n')
            elif js['code'] == 200000:
                return js['url']
            else:
                return None

        def retext(touser,fromuser,time,text):
            xmlForm = '''
                <xml>
                <ToUserName><![CDATA[%s]]></ToUserName>
                <FromUserName><![CDATA[%s]]></FromUserName>
                <CreateTime>%d</CreateTime>
                <MsgType><![CDATA[text]]></MsgType>
                <Content><![CDATA[%s]]></Content>
                </xml>
                '''%(fromuser,touser,time,text)
            return xmlForm
       
        xmldata = ET.fromstring(request.body)

        tousername = xmldata.find('ToUserName').text
        fromusername = xmldata.find('FromUserName').text
        msgtype = xmldata.find('MsgType').text
        time = int(time.time())

        if msgtype == 'text':
            gettext = getjson(xmldata)
        elif msgtype == 'event':
            status = xmldata.find('Event').text
            if status == 'subscribe':
                gettext = 'welcome'
            elif status == 'unsubscribe':
                pass

        re = retext(tousername,fromusername,time,gettext)
        return re

    if request.method == "GET":
        return HttpResponse(get(request))
    elif request.method == "POST":
        return HttpResponse(post(request))
